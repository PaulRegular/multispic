# Methods {-}

## Model formulation {-}

Trends in fish populations have frequently been described using state-space production models of the form

\begin{align}
B_y =& \left ( B_{y-1} + g(B_{y - 1}) - C_{y - 1} \right ) e^{\delta_y} & (\#eq:pro) \\
\\
I_{y, i} =& q_i B_y e^{\varepsilon_{y, i}} & (\#eq:obs)
\end{align}

where $B_y$ is biomass at the start of year $y$, $C_y$ is the catch through year $y$, $g(B)$ is production as a function of biomass, $I_{y,s}$ is an index of relative abundance in year $y$ from survey $i$, $q_i$ is the time-invariant catchability coefficient for survey index $i$, $\delta$ is process error, and $\varepsilon$ is observation error. Statistical challenges aside, the most difficult aspect of this model to parameterize is the production function as it needs to capture changes caused by growth, recruitment, and natural mortality. Schaefer [-@schaefer1954] proposed a solution by applying the logistic equation to describe self-limiting growth, 

\begin{align}
g(B) = rB \left( 1 - \frac{B}{K} \right), & (\#eq:logistic)
\end{align}

where $r$ is the maximum per-capita rate of change and $K$ is the carrying capacity. That is, a populations' intrinsic ability to grow ($rB$) is limited by the size of the current population relative to the maximum biomass the system can support ($1 - B/K$). While this formulation offers an elegant description of single-species population dynamics, it assumes that density-dependent effects are solely caused by intraspecific competition and ignores the potential effects of other species inhabiting the same ecological area. We present an extension of equation \@ref(eq:logistic) that attempts to account for intra and interspecific competition by assuming that density-dependent effects are incurred when the total biomass of multiple species, represented by $s$, exceeds the capacity of the system, 

\begin{align}
g(B_s) = r_s B_s \left (1 - \frac{\sum_{s} B_s}{K} \right ). & (\#eq:ms-logistic)
\end{align}

While intrinsic rates of growth may vary across species, this formulation implies that the growth of all species is ultimately limited by the finite amount of energy in a region (i.e., as the population in the system increases towards $K$, year-over-year growth of all species slows). Combining equations \@ref(eq:pro), \@ref(eq:obs), and \@ref(eq:ms-logistic), our model becomes

\begin{align}
B_{y, s} =& \left ( B_{y-1, s} + r_s B_{y-1, s} \left (1 - \frac{\sum_{s} B_{y-1, s}}{K} \right ) - C_{y - 1, s} \right ) e^{\delta_{y, s}} & (\#eq:ms-pro) \\
\\
I_{y, i, s} =& q_{i, s} B_{y, s} e^{\varepsilon_{y, i, s}}. & (\#eq:ms-obs)
\end{align}

The inclusion of multiple species in the model permits the estimation of covariance. While covarying changes in observed populations may be described using observation errors, we assume that most covariance stems from population processes. We therefore assume that observation errors are independent and normal distribution such that $\varepsilon_{y, i, s} \sim N(0, \tau_{i, s})$, where the standard deviation parameter $\tau_{i, s}$ represents species and survey specific levels of observation error. A more flexible error structure is used to describe the process errors as ecological processes may contribute to species or temporal dependencies. Beyond the global limiting effect of $K$, species interactions may elicit positive or negative population responses resulting from direct or indirect associations. We therefore apply the multivariate normal distribution to account for the possibility that process errors are not independent across species. Deviations from expected production may also display temporal dependence if the factors contributing to the process errors change slowly through time. Such inertia may cause positive or negative process errors to persist across several years. A first-order autoregressive (AR1) process was therefore applied to account for temporal dependence. Both sources of dependence are modeled using a multivariate AR1 process where

\begin{align}
\delta_{0, s} \sim& N(0, \Sigma_s) & \\
\delta_{1, s} =& \phi \delta_{0} + \sigma_s \varepsilon_{1}, \quad \varepsilon_{1} \sim N(0, \Sigma_s)  & (\#eq:ar1) \\
\delta_{y, s} =& \phi \delta_{y - 1} + \sigma_s \varepsilon_{y}, \quad \varepsilon_{y} \sim N(0, \Sigma_s) & 
\end{align}

and

\begin{align}
\Sigma_s = \begin{bmatrix}
\sigma^2_{1} &  \sigma_{1} \sigma_{2} \rho_{1,2}  & \dots &  \sigma_{1} \sigma_{s} \rho_{1,s} & \\
\sigma_{2} \sigma_{1} \rho_{2,1}       & \sigma^2_{2}     & \dots & \sigma_{2} \sigma_{s} \rho_{2,s}  & \\
\vdots & \vdots &  \ddots     &  \vdots & \\
\sigma_{s} \sigma_{1} \rho_{s,1} & \sigma_{s} \sigma_{2} \rho_{s,2} & \dots  &  \sigma^2_{s} &
\end{bmatrix}. & (\#eq:sigma)
\end{align}

The degree of temporal correlation is controlled by $\phi$, where values between 0 to 1 represent low to high correlation, and species-to-species correlations are described by $\rho_{s, s}$, where values between -1 to 1 represent negative to positive correlation. This is a flexible structure that allows for the testing of alternate hypotheses that process errors are independent through time or across species (i.e, $\phi = 0$ or $\rho_{s, s} = 0$). The possibility that process errors are similarly correlated across all species may also be tested by estimating only one $\rho$ parameter. Finally, the magnitude of the process error deviations are controlled by the species-specific standard deviation parameters, $\sigma_s$.

Minor extensions of the formulation also permits the fitting of covariates which may describe an underlying linear effect. Two options were implemented, one that affects the process errors by substituting $e^{\delta{y,s}}$ in equation \@ref(eq:ms-pro) with $e^{\beta_{\delta} X^{\delta}_{y,s} + \delta_{y, s}}$, and another that affects the carrying capacity by substituting $K$ in equation \@ref(eq:ms-pro) with $K e^{\beta_K X^K_{y}}$. The idea is that some factors may affect positive or negative changes in the populations while others may affect change in the total carrying capacity of the system. A covariate option for intrinsic rates of increase was not implemented as one goal of this model is to obtain estimates of this vital rate, which is not expected to change rapidly as it is shaped by natural selection [@hutchings2021]. The formulation was also modified to fit the single-species Schaefer production function by dropping the summation of biomass in equation \@ref(eq:ms-pro) and estimating species-specific carrying capacities, $K_s$ (i.e., apply equation \@ref(eq:logistic) indexed by species).

## Statistical framework {-}

This model was implemented using template model builder [TMB\; @kristensen2015], which is package for R [@R] that enables the fitting of complex nonlinear random effects such as the latent $B$ variable in state-space production models (equation \@ref(eq:pro)). Such variables are not directly measured but are inferred indirectly via observed values. Data fitting is accomplished using a combination of Laplace approximation and automatic differentiation to evaluate the joint likelihood [@kristensen2015]. Like the production model descried by Pedersen et al. [-@pedersen2017], both frequentist and Bayesian inference of model parameters are possible. In development, we found that estimation was generally more successful when vaguely informative priors are specified as parameters were, in some cases, not identifiable when unconstrained.

## Case study {-}

### Data {-}

The multispecies production model described above requires two basic inputs for one or more species in a region: 1) a time-series of catch ($C_{y,s}$ in equation \@ref(eq:ms-pro)), and 2) an index of population size ($I_{y,s}$ in equation \@ref(eq:ms-obs)). The Northwest Atlantic Fisheries Organization (NAFO) and Fisheries and Oceans Canada (DFO) have been collecting and curating such information for multiple fish populations along the shelves of Newfoundland and Labrador (NL) since the 1970s. The communities inhabiting these shelves can be divided into several regions with distinct productivity [i.e. ecosystem production units; @pepin2014]. For our case study, we tallied catch data and calculated survey indices of multiple demersal fish populations from three regions: 1) the Northeast NL Shelf (NAFO divisions 2J3K), 2) the Grand Bank (NAFO divisions 3LNO), and 3) Southern NL (NAFO sub-division 3Ps; Figure \@ref(fig:epu-map)). 

Catch data were extracted from the STATLANT 21A database maintained by NAFO (https://www.nafo.int/Data/STATLANT-21A, accessed 2022-01-21) and aggregated by region, species, and year. Survey indices were derived from the standardized, stratified random bottom-trawl surveys conducted each spring and fall by DFO. Since the inception of this program in 1971, survey protocol have undergone a series of changes that affect the continuity of the data collected in each region and season. A Yankee then Engel otter trawl, with nets designed to catch large demersal fish, were used between 1971 to 1994. Since 1995, a Campelen shrimp trawl has been used and, because of its smaller mesh size, a broader range of species and size groups have been captured [@chadwick2007]. Within each era of the survey (Yankee, Engel, or Campelen) and for each season and region, samples were limited to strata that were covered most years (> 80%) and to species found across more than 10% of these core strata. Stratified analyses [@smith1981] were then conducted on the remaining species to obtain indices of total biomass. To minimize bias introduced by inconsistent survey coverage, indices from years where more than 20% of the biomass was likely missed, inferred from time averaged percent occupancy within strata, were excluded from our analysis [*sensu* NAFO guidelines; page 10, @nafo2019]. Finally, species were ranked by cumulative catch and limited to the the seven most commonly caught species, or species group when catch was not consistently distinguished, within each region. On the Northeast NL Shelf, species include Redfish spp. (*Sebastes fasciatus* or *S. mentella*), Wolffish spp. (*Anarhichas lupus* or *A. minor*), Witch Flounder (*Glyptocephalus cynoglossus*), American Plaice (*Hippoglossoides platessoides*), Greenland Halibut (*Reinhardtius hippoglossoides*), Atlantic Cod (*Gadus morhua*), and Skate spp. (*Amblyraja radiata* or *Malacoraja senta*). On the Grand Bank, species include Redfish spp., Yellowtail Flounder (*Limanda ferruginea*), American Plaice, Greenland Halibut, Haddock (*Melanogrammus aeglefinus*), and Atlantic Cod. Finally, along Sourthern NL, species include Redfish spp., Witch Flounder, American Plaice, White hake (*Urophycis tenuis*), Haddock, Atlantic Cod, and Skate spp.


### Priors {-}

The priors chosen for our case study were loosely based on priors used by Froese et al. [-@froese2017]. For simplicity, all priors were normally distributed and upper and lower inflection points ($\mu \pm \sigma$; ~68% of the total area under the curve) of each normal prior were defined using values in log or logit space. 

#### *Intrinsic growth rate, $r$, and carrying capacity, $K$* {-}

To capture a broad range of predicted intrinsic growth rates for all fishes worldwide [@thorson2020], 0.01 and 0.1 were chosen as the lower, $r_l$, and upper, $r_u$, values; this translate to a normal prior with a mean of -1.15 and a standard deviation of 1.15 on the log-scale. The log-scale $K$ prior was informed by total levels of catch and $r_l$ and $r_u$,

\begin{align}
K_l = \frac{\max(\Sigma_s C_{s,y})}{r_u}, K_u = \frac{4 \max(\Sigma_s C_{s,y})}{r_l} & (\#eq:k-prior)
\end{align}

where $K_l$ and $K_u$ are the lower and upper values. On the lower end, this prior imposes the assumption that the fishery is unlikely to have caught more fish in a single year than the system is capable of supporting and, on the upper end, it assumes that the maximum observed catch represents a portion of the true carrying capacity of the system [*sensu* @froese2017]. The division by the lower and upper values for $r$ also accounts for the potential range of productivity. Note that the maximum time-series catches are species specific when estimating species-specific carrying capacities.


<!-- Here I present initial results from of a Shaffer surplus production model which has been modified to fit to multiple species: -->

<!-- $$B_{t, s} = \left (B_{t-1, s} + r_s B_{t-1, s} \left (1 - \left[ \frac{\sum_{s} B_{t-1, s}}{K} \right ] \right ) - L_{t-1, s} \right ) e^ {\beta X_t + {\delta_{t,s}}}$$ where -->

<!-- $$ \delta_{t,s} \sim N(0, \Sigma_s)$$ and -->

<!-- $$ \Sigma_s = \begin{bmatrix} -->
<!-- \sigma^2_{\delta~1} &  \sigma_{\delta~1} \sigma_{\delta~2} \rho_{1,2}  & \dots &  \sigma_{\delta~1} \sigma_{\delta~s} \rho_{1,s} & \\  -->
<!-- \sigma_{\delta~2} \sigma_{\delta~1} \rho_{2,1}       & \sigma^2_{\delta~2}     & \dots & \sigma_{\delta~2} \sigma_{\delta~s} \rho_{2,s}  & \\  -->
<!-- \vdots & \vdots &  \ddots     &  \vdots & \\  -->
<!-- \sigma_{\delta~s} \sigma_{\delta~1} \rho_{s,1} & \sigma_{\delta~s} \sigma_{\delta~2} \rho_{s,2} & \dots  &  \sigma^2_{\delta~s} &  -->
<!-- \end{bmatrix} $$ -->

<!-- The key difference here from a standard surplus production model is that biomass is indexed by species, $s$, and the ratio of biomass over carrying capacity is based on the total biomass of the species included in the model. Note that intrinsic growth rates, $r_s$, are species specific while only one carrying capacity $K$ parameter is estimated. Therefore, as the population in the system increases towards $K$, year-over-year growth of all species slows. The concept is that the species included in the model are limited by the finite amount of energy in the system. Another difference is the way the process error is modeled. Because multiple species are included, covariance between the species can be estimated. Here I model process error using the multivariate normal distribution and estimate standard deviation parameters ($\sigma^2_{\delta ~ s}$) for each species as well as the correlation in the errors across species ($\rho_{s,s}$). If these species are affected by similar drivers, then correlations will be positive. Alternatively, negative correlations may occur if there is competition or predator-prey interactions between two species. Finally, the formulation allows the fitting of covariates that may describe an underlying linear effect ($\beta X$). -->

<!-- The observation portion of this state-space model is -->

<!-- $$I_{t,s,g} = q_{s,g} ~ B_{t,s} ~ e^{\nu}$$ where -->

<!-- $$\nu \sim N(0, \sigma^2_{\nu ~ s,g})$$ Here $g$ represents survey grouping (e.g. season, gear). This allows for the catachability and variability of surveys to be species and survey specific. This model was constructed using Template Model Builder. -->

<!-- ### Data and priors -->

<!-- As a first-cut exploration, I apply this model to several groundfish species on the Grand Bank (3LNO): Yellowtail, Witch, Cod, Plaice, Skate, Hake, Haddock, Redfish. Landings data were obtained from the STATLANT21A database maintained by NAFO (<https://www.nafo.int/Data/STATLANT>). Survey indices are from Canadian spring and fall multispecies surveys. Three gear changes have occurred throughout the survey time-series, from Yankee, Engel and Campelen gear. Coverage of the Grand Bank has been inconsistent and, as such, the data has been restricted to years where 90% of the core area (strata that have been sampled for more than 20 years) has been covered by the survey. Separate catchabilities are estimated by season and gear type. -->

<!-- The same prior (mean = -1, sd = 1) was used on $log(r)$, $log(\sigma^2_{\delta ~ s})$, $log(q_{s,g})$ and $log(\sigma^2_{\nu ~ s,g})$, which corresponds to 95% interval of 0.05 and 2.61. These general priors stabilized convergence by penalizing large deviations into unrealistic parameter space \[i.e. growth ($r$), catchability ($q$) and variance ($\sigma^2$) parameters are not expected to move far outside the 0.05 - 2.61 range\]. -->

<!-- ### Model selection -->

<!-- A range of models have been tested and compared: -->

<!-- 1.  null: assumes no correlation across species and no covariate effects. -->
<!-- 2.  one: assumes one common correlation parameters across species and no covariate effects -->
<!-- 3.  cil: assumes no correlation across species but adds core cold intermediate layer (CIL) temperature as a covariate -->
<!-- 4.  cei: assumes no correlation across species but adds composite environmental index (CEI) as a covariate -->
<!-- 5.  cil_one: assumes one correlation parameter and adds core CIL temperature as a covariate -->
<!-- 6.  cei_one: assumes one correlation parameter and adds CEI as a covariate -->

<!-- Models are compared using marginal AIC -->

<!-- $$mAIC =  2k + 2log(\hat{L}),$$ -->

<!-- where $k$ is the number of fixed parameters and $log(\hat{L})$ is the negative log likelihood, and leave-one-out cross-validation score -->

<!-- $$LOOCV = \frac{1}{n} \sum_{i-1}^{n} \left (  log(I_i) - log(\hat{I}_i) \right ) ^ 2$$ LOOCV is the mean squared error of the log estimates of the survey indices $\hat{I}$, under consecutive model runs where each observation $i$ was left out. For both metrics, lower values indicate models with greater predictive ability. -->
