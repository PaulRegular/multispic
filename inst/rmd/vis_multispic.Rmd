---
title: "multispic diagnostics and results"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r setup, echo=FALSE}
library(plotly)
library(viridis)
knitr::opts_chunk$set(echo = FALSE, fig.height = 7, fig.width = 8, cache = FALSE)
```


```{r options}

if (fit$call$K_groups == ~1) {
    K_groups <- NULL
    if (length(unique(fit$landings$species)) == 1) {
        K_label <- "K"
    } else {
        K_label <- "All species"
    }
} else {
    K_groups <- as.formula(fit$call$K_groups)
    K_label <- unique(fit$landings[, all.vars(K_groups)])
}

n_covar <-  length(all.vars(fit$call$pe_covariates))

add_labels <- function(p, xlab = "", ylab = "", log_linear_button = TRUE) {
  
  if (log_linear_button) {
    ## Modified from https://stackoverflow.com/a/60551263/4055438
    buttons <- list(list(
      active = 0,
      type = "buttons",
      buttons= list(
        list(label = 'linear',
             method = 'relayout',
             args = list(list(yaxis = list(type = 'linear', title = ylab)))),
        list(label = 'log',
             method = 'relayout', 
             args = list(list(yaxis = list(type = 'log', title = ylab)))))))
  } else {
    buttons <- NULL
  }
  
  layout(p, 
         xaxis = list(title = xlab),
         yaxis = list(title = ylab),
         updatemenus = buttons)
  
}


```


Inputs
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### Index

```{r}
fit$index %>%
  plot_ly() %>%
  add_trace(x = ~year, y = ~index, color = ~survey,
            colors = viridis::viridis(100), mode = "markers+lines",
            type = "scatter") %>% 
  add_labels(xlab = "Year", ylab = "Index")
```


### Landings

```{r}
fit$landings %>%
    plot_ly() %>%
    add_trace(x = ~year, y = ~landings, color = ~species,
              colors = viridis::viridis(100), mode = "markers+lines",
              type = "scatter") %>% 
  add_labels(xlab = "Year", ylab = "Landings")
```


### Covariates

`r if (n_covar == 0) "N/A; no process error covariates supplied"`
`r if (n_covar > 1) "Plotting of more than one covariate not yet implemented"`

```{r, eval = n_covar == 1}
covariates <- unique(fit$landings[, c("year", all.vars(fit$call$pe_covariates)), drop = FALSE])
names(covariates) <- c("year", "covariate")
covariates %>% 
    plot_ly(x = ~year, y = ~covariate) %>% 
    add_trace(mode = "markers+lines") %>% 
    layout(xaxis = list(title = "Year"),
           yaxis = list(title = all.vars(fit$call$pe_covariates)))
```



Residuals
================================================================================

Row {.tabset}
--------------------------------------------------------------------------------

### Index

```{r}

```


Parameters
================================================================================

## Estimates

```{r}
## Prior posterior plots (turn off prior if not used)
```


Population trends
================================================================================

```{r}

```

